<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>hello knoght sik sog</title>
    <style>
      :root {
        --bg1: #071022;
        --bg2: #0f1b2b;
        --accent: #ff6b6b;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: linear-gradient(180deg, var(--bg1), var(--bg2));
        color: #e6eef8;
        font-family: Inter, system-ui, Segoe UI, Arial;
        overflow: hidden;
      }
      #wrap {
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      header {
        padding: 12px 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      h1 {
        margin: 0;
        color: #ffd6d6;
        letter-spacing: 2px;
        font-size: 18px;
      }
      button {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #e6eef8;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
      }
      #gameArea {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px;
        position: relative;
      }
      canvas {
        background: transparent;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
      }
      #hud {
        position: absolute;
        left: 18px;
        top: 70px;
        color: #cfe7ff;
        font-size: 15px;
        z-index: 9;
      }
      #status {
        position: absolute;
        right: 18px;
        top: 70px;
        color: #cfe7ff;
        font-size: 14px;
      }
      #overlay {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        z-index: 20;
      }
      .panel {
        pointer-events: auto;
        background: linear-gradient(
          180deg,
          rgba(6, 6, 10, 0.9),
          rgba(10, 10, 16, 0.96)
        );
        border: 1px solid rgba(255, 255, 255, 0.03);
        padding: 20px;
        border-radius: 12px;
        color: #dcecff;
        max-width: 920px;
      }
      .controls {
        font-size: 13px;
        opacity: 0.85;
        margin-top: 8px;
      }
      .muted {
        opacity: 0.6;
        font-size: 13px;
        margin-top: 6px;
      }
      footer {
        padding: 8px 18px;
        text-align: center;
        font-size: 12px;
        color: #9fb0c9;
      }
      .small {
        color: var(--accent);
        text-decoration: none;
      }
      .bigbtn {
        background: var(--accent);
        border: none;
        color: #111;
        padding: 8px 14px;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
      }
      img.victory {
        max-width: 92%;
        height: auto;
        display: block;
        margin: 12px auto;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div id="wrap">
      <header>
        <h1>Hello knoght</h1>
        <div>
          <button id="startBtn">Start</button>
          <button id="restartBtn" style="display: none">Restart</button>
        </div>
      </header>

      <div id="gameArea">
        <canvas id="c" width="1024" height="576"></canvas>
        <div id="hud">❤ 6 &nbsp;&nbsp; Lantern Sharts: 0</div>
        <div id="status">Level: 0 / 10</div>
      </div>

      <footer>ok so press z to uhhh and x to uhhh i forgor</footer>
    </div>

    <!-- overlay panel for menus -->
    <div id="overlay">
      <div id="panel" class="panel" style="display: none">
        <h2 id="panelTitle">Prologue</h2>
        <div id="panelContent"></div>
        <div class="controls">
          <strong>Controls:</strong> ← → / A D = move • ↑ / W / Space = jump • Z
          = attack • X = dash
        </div>
        <div class="muted">
          press restart on level 9 it does nothing i swear!
        </div>
      </div>
    </div>

    <script>
      /* hello knoght
      - add shit
      - more shit
      - better shit
*/

      // CANVAS
      const canvas = document.getElementById("c");
      const ctx = canvas.getContext("2d");
      const W = canvas.width,
        H = canvas.height;

      // INPUT
      let keys = {};
      document.addEventListener("keydown", (e) => {
        keys[e.code] = true;
      });
      document.addEventListener("keyup", (e) => {
        keys[e.code] = false;
      });

      // UTILS
      const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
      function rand(min = 0, max = 1) {
        return min + Math.random() * (max - min);
      }
      function circle(ctx, x, y, r) {
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fill();
      }

      // GAME STATE
      let running = false;
      let last = 0;
      let player, camera, world, particles, enemies;
      let levelIndex = 0;
      const MAX_LEVELS = 10;
      let loadedImages = 0,
        totalToLoad = 3;
      let gameWon = false;

      // ---------- PLAYER SPRITES (USER PROVIDED) ----------
      const SPR_idle = new Image();
      SPR_idle.src = "https://gcdnb.pbrd.co/images/Pk9Y2NY7hzMP.png?o=1";
      const SPR_attack = new Image();
      SPR_attack.src = "https://gcdnb.pbrd.co/images/vGKzldouEUb5.png?o=1";
      const SPR_dash = new Image();
      SPR_dash.src = "https://gcdnb.pbrd.co/images/Lt8AdYAxm5NM.png?o=1";

      // image loaded bookkeeping
      [SPR_idle, SPR_attack, SPR_dash].forEach((img) => {
        img.onload = () => {
          loadedImages++;
        };
        img.onerror = () => {
          loadedImages++;
        }; // proceed even if one fails
      });

      // Enemy visuals: draw with canvas (no external dependency)
      function drawEnemySprite(ctx, x, y, w, h, tint = "#ff9b9b") {
        ctx.save();
        ctx.fillStyle = tint;
        ctx.beginPath();
        ctx.moveTo(x + w * 0.5, y);
        ctx.quadraticCurveTo(x + w, y + h * 0.2, x + w, y + h * 0.6);
        ctx.quadraticCurveTo(x + w * 0.9, y + h * 0.95, x + w * 0.5, y + h);
        ctx.quadraticCurveTo(x + w * 0.1, y + h * 0.95, x, y + h * 0.6);
        ctx.quadraticCurveTo(x, y + h * 0.2, x + w * 0.5, y);
        ctx.fill();
        // eyes
        ctx.fillStyle = "#ffdede";
        ctx.fillRect(x + w * 0.22, y + h * 0.32, w * 0.12, h * 0.12);
        ctx.fillRect(x + w * 0.66, y + h * 0.32, w * 0.12, h * 0.12);
        // small antenna
        ctx.strokeStyle = "rgba(255,255,255,0.08)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(x + w * 0.38, y + h * 0.06);
        ctx.quadraticCurveTo(
          x + w * 0.25,
          y - h * 0.15,
          x + w * 0.15,
          y - h * 0.05
        );
        ctx.stroke();
        ctx.restore();
      }

      // ---------- LEVEL DATA (10 levels) ----------
      const levels = [];
      function makeLevel(
        width,
        platformDefs,
        hazardDefs,
        enemyDefs,
        shardDefs
      ) {
        return {
          width,
          platforms: platformDefs,
          hazards: hazardDefs || [],
          enemies: enemyDefs || [],
          shards: shardDefs || [],
        };
      }

      // 10 handcrafted levels (same as before)
      levels.push(
        makeLevel(
          1600,
          [
            { x: 0, y: 520, w: 1600, h: 56 },
            { x: 220, y: 420, w: 120, h: 14 },
            { x: 420, y: 360, w: 160, h: 14 },
            { x: 720, y: 300, w: 180, h: 14 },
            { x: 1100, y: 380, w: 140, h: 14 },
          ],
          [{ x: 760, y: 520, w: 80, h: 56 }],
          [
            { x: 700, y: 456 },
            { x: 1200, y: 336 },
          ],
          [
            { x: 420, y: 330 },
            { x: 1320, y: 350 },
          ]
        )
      );

      levels.push(
        makeLevel(
          1800,
          [
            { x: 0, y: 520, w: 1800, h: 56 },
            { x: 280, y: 430, w: 160, h: 14 },
            { x: 520, y: 360, w: 200, h: 14 },
            { x: 900, y: 300, w: 180, h: 14 },
            { x: 1400, y: 380, w: 180, h: 14 },
          ],
          [{ x: 1020, y: 520, w: 80, h: 56 }],
          [
            { x: 600, y: 456 },
            { x: 1500, y: 336 },
          ],
          [
            { x: 600, y: 330 },
            { x: 1500, y: 340 },
          ]
        )
      );

      levels.push(
        makeLevel(
          2000,
          [
            { x: 0, y: 520, w: 2000, h: 56 },
            { x: 340, y: 440, w: 140, h: 14 },
            { x: 680, y: 380, w: 140, h: 14 },
            { x: 980, y: 320, w: 220, h: 14 },
            { x: 1360, y: 360, w: 160, h: 14 },
            { x: 1680, y: 300, w: 180, h: 14 },
          ],
          [{ x: 1180, y: 520, w: 100, h: 56 }],
          [
            { x: 900, y: 456 },
            { x: 1250, y: 296 },
          ],
          [
            { x: 980, y: 280 },
            { x: 1700, y: 260 },
          ]
        )
      );

      levels.push(
        makeLevel(
          2000,
          [
            { x: 0, y: 520, w: 2000, h: 56 },
            { x: 200, y: 420, w: 200, h: 14 },
            { x: 520, y: 340, w: 120, h: 14 },
            { x: 760, y: 300, w: 160, h: 14 },
            { x: 1100, y: 360, w: 140, h: 14 },
            { x: 1500, y: 320, w: 160, h: 14 },
          ],
          [
            { x: 420, y: 520, w: 60, h: 56 },
            { x: 1620, y: 520, w: 80, h: 56 },
          ],
          [
            { x: 480, y: 456 },
            { x: 1400, y: 296 },
            { x: 1750, y: 456 },
          ],
          [
            { x: 320, y: 300 },
            { x: 1120, y: 320 },
          ]
        )
      );

      levels.push(
        makeLevel(
          2200,
          [
            { x: 0, y: 520, w: 2200, h: 56 },
            { x: 260, y: 420, w: 140, h: 14 },
            { x: 520, y: 360, w: 140, h: 14 },
            { x: 820, y: 300, w: 160, h: 14 },
            { x: 1260, y: 360, w: 160, h: 14 },
            { x: 1600, y: 320, w: 180, h: 14 },
          ],
          [{ x: 1960, y: 520, w: 80, h: 56 }],
          [
            { x: 700, y: 456 },
            { x: 1350, y: 336 },
            { x: 1800, y: 296 },
          ],
          [
            { x: 540, y: 320 },
            { x: 1640, y: 340 },
          ]
        )
      );

      levels.push(
        makeLevel(
          2400,
          [
            { x: 0, y: 520, w: 2400, h: 56 },
            { x: 300, y: 440, w: 160, h: 14 },
            { x: 640, y: 380, w: 120, h: 14 },
            { x: 940, y: 320, w: 160, h: 14 },
            { x: 1280, y: 360, w: 200, h: 14 },
            { x: 1760, y: 300, w: 200, h: 14 },
          ],
          [{ x: 980, y: 520, w: 80, h: 56 }],
          [
            { x: 760, y: 456 },
            { x: 1000, y: 296 },
            { x: 1900, y: 456 },
          ],
          [
            { x: 820, y: 300 },
            { x: 1980, y: 320 },
          ]
        )
      );

      levels.push(
        makeLevel(
          2600,
          [
            { x: 0, y: 520, w: 2600, h: 56 },
            { x: 400, y: 420, w: 160, h: 14 },
            { x: 700, y: 360, w: 180, h: 14 },
            { x: 1060, y: 300, w: 160, h: 14 },
            { x: 1380, y: 380, w: 140, h: 14 },
            { x: 1980, y: 320, w: 200, h: 14 },
          ],
          [{ x: 1620, y: 520, w: 80, h: 56 }],
          [
            { x: 840, y: 456 },
            { x: 1320, y: 336 },
            { x: 2200, y: 296 },
          ],
          [
            { x: 540, y: 320 },
            { x: 2080, y: 340 },
          ]
        )
      );

      levels.push(
        makeLevel(
          2800,
          [
            { x: 0, y: 520, w: 2800, h: 56 },
            { x: 240, y: 420, w: 140, h: 14 },
            { x: 480, y: 360, w: 160, h: 14 },
            { x: 760, y: 300, w: 200, h: 14 },
            { x: 1240, y: 360, w: 160, h: 14 },
            { x: 1760, y: 320, w: 200, h: 14 },
            { x: 2320, y: 360, w: 160, h: 14 },
          ],
          [{ x: 1260, y: 520, w: 80, h: 56 }],
          [
            { x: 920, y: 456 },
            { x: 1600, y: 336 },
            { x: 2500, y: 456 },
          ],
          [
            { x: 320, y: 300 },
            { x: 2100, y: 320 },
          ]
        )
      );

      levels.push(
        makeLevel(
          3000,
          [
            { x: 0, y: 520, w: 3000, h: 56 },
            { x: 360, y: 440, w: 160, h: 14 },
            { x: 740, y: 380, w: 160, h: 14 },
            { x: 1040, y: 320, w: 200, h: 14 },
            { x: 1440, y: 360, w: 160, h: 14 },
            { x: 1980, y: 300, w: 220, h: 14 },
            { x: 2540, y: 360, w: 200, h: 14 },
          ],
          [{ x: 1860, y: 520, w: 80, h: 56 }],
          [
            { x: 1100, y: 456 },
            { x: 1700, y: 296 },
            { x: 2400, y: 456 },
          ],
          [
            { x: 980, y: 300 },
            { x: 2600, y: 340 },
          ]
        )
      );

      levels.push(
        makeLevel(
          3200,
          [
            { x: 0, y: 520, w: 3200, h: 56 },
            { x: 220, y: 420, w: 120, h: 14 },
            { x: 420, y: 360, w: 160, h: 14 },
            { x: 720, y: 300, w: 180, h: 14 },
            { x: 1100, y: 380, w: 140, h: 14 },
            { x: 1360, y: 320, w: 160, h: 14 },
            { x: 1700, y: 380, w: 300, h: 14 },
            { x: 2120, y: 300, w: 200, h: 14 },
            { x: 2500, y: 420, w: 180, h: 14 },
          ],
          [{ x: 1960, y: 520, w: 60, h: 56 }],
          [
            { x: 900, y: 456 },
            { x: 1500, y: 336 },
            { x: 2400, y: 456 },
          ],
          [
            { x: 420, y: 330 },
            { x: 2800, y: 360 },
          ]
        )
      );

      // ---------- PLAYER / ENEMY FACTORIES ----------
      function createPlayer() {
        return {
          x: 120,
          y: 420,
          w: 48,
          h: 64,
          vx: 0,
          vy: 0,
          speed: 3.2,
          jump: -12.8,
          grounded: false,
          facing: 1,
          attacking: 0,
          dashCooldown: 0,
          health: 6,
          maxHealth: 6,
          invuln: 0,
          lanternShards: 0,
          anim: { frame: 0, t: 0, speed: 0.12 },
          state: "idle",
        };
      }

      function spawnEnemy(x, y) {
        return {
          x: x,
          y: y - 40,
          w: 40,
          h: 40,
          vx: 1.0,
          dir: 1,
          patrolLeft: x - 120,
          patrolRight: x + 120,
          alive: true,
          health: 2,
          stunned: 0,
        };
      }

      // particles
      function createParticles() {
        return [];
      }
      function spawnDust(x, y, amount = 6) {
        for (let i = 0; i < amount; i++) {
          particles.push({
            x: x + rand(-8, 8),
            y: y + rand(-4, 4),
            vx: rand(-1.2, 1.2),
            vy: rand(-3, -0.4),
            life: rand(30, 80),
            size: rand(1.5, 4),
            col: "rgba(200,230,255,0.6)",
          });
        }
      }

      // ---------- INIT / RESET ----------
      function reset() {
        world = JSON.parse(JSON.stringify(levels[levelIndex]));
        player = createPlayer();
        camera = { x: 0, y: 0, shake: 0 };
        particles = createParticles();
        enemies = [];
        for (const e of world.enemies) enemies.push(spawnEnemy(e.x, e.y));
        world.shards = (world.shards || []).map((s) => ({
          x: s.x,
          y: s.y,
          w: 14,
          h: 14,
        }));
        running = true;
        gameWon = false;
        updateHUD();
        document.getElementById("status").textContent = `Level: ${
          levelIndex + 1
        } / ${MAX_LEVELS}`;
      }

      // ---------- COLLISION ----------
      function rectsOverlap(a, b) {
        return (
          a.x < b.x + (b.w || 0) &&
          a.x + (a.w || 0) > b.x &&
          a.y < b.y + (b.h || 0) &&
          a.y + (a.h || 0) > b.y
        );
      }

      // ---------- HUD ----------
      function updateHUD() {
        const hud = document.getElementById("hud");
        hud.innerHTML = `❤ ${player.health} &nbsp;&nbsp; Lantern Shards: ${player.lanternShards}`;
        document.getElementById("status").textContent = `Level: ${
          levelIndex + 1
        } / ${MAX_LEVELS}`;
      }

      // ---------- UI PANEL ----------
      const overlay = document.getElementById("overlay");
      const panel = document.getElementById("panel");
      const panelTitle = document.getElementById("panelTitle");
      const panelContent = document.getElementById("panelContent");

      function showPanel(title, html) {
        panelTitle.textContent = title;
        panelContent.innerHTML = html;
        panel.style.display = "block";
        overlay.style.pointerEvents = "auto";
        overlay.style.display = "flex";
      }
      function hidePanel() {
        panel.style.display = "none";
        overlay.style.pointerEvents = "none";
        overlay.style.display = "none";
      }

      // ---------- DEATH HANDLER ----------
      function handlePlayerDeath() {
        running = false;
        showPanel(
          "Game Over",
          `<p style="line-height:1.4">FUCK YOU BITCH YOU DIED</p>
    <div style="margin-top:12px;text-align:right">
      <button id="restartGameOver" class="bigbtn">Restart</button>
    </div>`
        );
        // restart listener
        document
          .getElementById("restartGameOver")
          .addEventListener("click", () => {
            levelIndex = 0;
            hidePanel();
            reset();
            last = performance.now();
            requestAnimationFrame(loop);
            document.getElementById("startBtn").style.display = "none";
            document.getElementById("restartBtn").style.display =
              "inline-block";
          });
      }

      // ---------- UPDATE (physics, ai) ----------
      function update(dt) {
        if (!running) return;

        const left = keys["ArrowLeft"] || keys["KeyA"];
        const right = keys["ArrowRight"] || keys["KeyD"];
        const up = keys["ArrowUp"] || keys["KeyW"] || keys["Space"];

        // movement
        if (left && !right) {
          player.vx = clamp(player.vx - 0.9, -player.speed * 1.7, player.speed);
          player.facing = -1;
        } else if (right && !left) {
          player.vx = clamp(player.vx + 0.9, -player.speed, player.speed * 1.7);
          player.facing = 1;
        } else {
          player.vx *= 0.78;
          if (Math.abs(player.vx) < 0.11) player.vx = 0;
        }

        // dash
        if ((keys["KeyX"] || keys["ShiftLeft"]) && player.dashCooldown <= 0) {
          player.dashCooldown = 40;
          player.vx += player.facing * 10;
          spawnDust(player.x + player.w / 2, player.y + player.h - 8, 12);
        }
        if (player.dashCooldown > 0) player.dashCooldown--;

        // jump
        if (up && player.grounded) {
          player.vy = player.jump;
          player.grounded = false;
          spawnDust(player.x + player.w / 2, player.y + player.h - 6, 10);
        }

        // attack
        if (keys["KeyZ"] && !player.attacking) {
          player.attacking = 12;
        }
        if (player.attacking) player.attacking--;

        // physics
        player.vy += 0.72;
        player.x += player.vx;
        player.y += player.vy;

        // platforms
        player.grounded = false;
        for (const p of world.platforms) {
          if (player.x < p.x + p.w && player.x + player.w > p.x) {
            if (
              player.y + player.h > p.y &&
              player.y + player.h < p.y + 16 &&
              player.vy >= 0
            ) {
              player.y = p.y - player.h;
              player.vy = 0;
              player.grounded = true;
            }
          }
        }

        // fell off
        if (player.y > H + 220) {
          player.x = Math.max(80, player.x - 120);
          player.y = 200;
          player.vy = 0;
          player.health = Math.max(0, player.health - 1);
          camera.shake = 14;
          spawnDust(player.x + player.w / 2, player.y + player.h / 2, 18);
          updateHUD();
          if (player.health <= 0) {
            handlePlayerDeath();
            return;
          }
        }

        // clamp
        player.x = clamp(player.x, 0, world.width - player.w);

        // enemies update
        for (const e of enemies) {
          if (!e.alive) continue;
          e.x += e.vx * e.dir;
          if (e.x < e.patrolLeft) e.dir = 1;
          if (e.x > e.patrolRight) e.dir = -1;
          if (e.stunned > 0) e.stunned--;

          // platform snap
          for (const p of world.platforms) {
            if (e.x < p.x + p.w && e.x + e.w > p.x) {
              if (e.y + e.h > p.y && e.y + e.h < p.y + 16) {
                e.y = p.y - e.h;
              }
            }
          }

          // player attack
          if (player.attacking > 6) {
            const reach = {
              x: player.facing === 1 ? player.x + player.w : player.x - 40,
              y: player.y + 8,
              w: 44,
              h: 28,
            };
            if (rectsOverlap(reach, e) && e.alive) {
              e.health -= 1;
              e.stunned = 26;
              spawnDust(e.x + e.w / 2, e.y + e.h / 2, 8);
              if (e.health <= 0) {
                e.alive = false;
                spawnDust(e.x + e.w / 2, e.y + e.h / 2, 26);
              }
            }
          }

          // enemy hits player (buffered)
          const buffedEnemy = {
            x: e.x + 4,
            y: e.y + 4,
            w: e.w - 8,
            h: e.h - 8,
          };
          if (
            rectsOverlap(player, buffedEnemy) &&
            e.alive &&
            player.invuln <= 0
          ) {
            player.health = Math.max(0, player.health - 1);
            player.invuln = 80;
            player.vy = -8;
            camera.shake = 16;
            spawnDust(player.x + player.w / 2, player.y + player.h / 2, 16);
            updateHUD();
            if (player.health <= 0) {
              handlePlayerDeath();
              return;
            }
          }
        }

        if (player.invuln > 0) player.invuln--;

        // particles
        for (let i = particles.length - 1; i >= 0; i--) {
          const p = particles[i];
          p.vy += 0.12;
          p.x += p.vx;
          p.y += p.vy;
          p.life--;
          if (p.life <= 0) particles.splice(i, 1);
        }

        // shards
        for (let i = world.shards.length - 1; i >= 0; i--) {
          const s = world.shards[i];
          if (rectsOverlap(player, s)) {
            player.lanternShards++;
            world.shards.splice(i, 1);
            spawnDust(s.x + (s.w || 12) / 2, s.y + (s.h || 12) / 2, 16);
          }
        }

        // camera
        const targetX = clamp(
          player.x - W / 2 + player.w / 2,
          0,
          Math.max(0, world.width - W)
        );
        camera.x += (targetX - camera.x) * 0.12;
        if (camera.shake > 0) camera.shake = Math.max(0, camera.shake - 1);

        // level end
        const levelEndZone = world.width - player.w - 8;
        if (player.x >= levelEndZone) {
          levelIndex++;
          if (levelIndex >= MAX_LEVELS) {
            running = false;
            // show victory with the user-provided base64 image
            const base64img =
              "data:image/jpeg;base64,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";
            // show victory panel with image
            showPanel(
              "Victory",
              `<p style="line-height:1.2">YOU FUCKING FINISHED ${MAX_LEVELS} levels mate. go fucking touch grass or five fingers will come.</p><img class="victory" src="${base64img}" alt="Victory image"><div style="text-align:right"><button id="restartWin" class="bigbtn">Restart</button></div>`
            );
            document
              .getElementById("restartWin")
              .addEventListener("click", () => {
                levelIndex = 0;
                hidePanel();
                reset();
                last = performance.now();
                requestAnimationFrame(loop);
                document.getElementById("startBtn").style.display = "none";
                document.getElementById("restartBtn").style.display =
                  "inline-block";
              });
          } else {
            // next level panel
            running = false;
            showPanel(
              "Stage Clear",
              `<p style="line-height:1.2">Proceeding to level ${
                levelIndex + 1
              }.</p><div style="text-align:right"><button id="nextLVL" class="bigbtn">Continue</button></div>`
            );
            document.getElementById("nextLVL").addEventListener("click", () => {
              hidePanel();
              reset();
              last = performance.now();
              requestAnimationFrame(loop);
            });
          }
        }

        updateHUD();
      }

      // ---------- DRAW ----------
      function draw() {
        ctx.clearRect(0, 0, W, H);
        const g = ctx.createLinearGradient(0, 0, 0, H);
        g.addColorStop(0, "#041021");
        g.addColorStop(1, "#071826");
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, W, H);

        // parallax
        ctx.save();
        ctx.translate(-Math.floor(camera.x * 0.2), 0);
        ctx.fillStyle = "#071426";
        ctx.fillRect(0, H - 120, W * 2, 120);
        ctx.restore();

        // world-space
        ctx.save();
        ctx.translate(-Math.floor(camera.x), 0);

        // fog stripes
        ctx.fillStyle = "rgba(170,200,230,0.02)";
        for (let i = 0; i < 6; i++) ctx.fillRect(0, i * 90 + 28, W, 18);

        // platforms
        for (const p of world.platforms) {
          roundRect(ctx, p.x, p.y, p.w, p.h, 6, true, false, "#06121a");
          ctx.fillStyle = "rgba(255,255,255,0.03)";
          ctx.fillRect(p.x + 4, p.y + 2, p.w - 8, 4);
        }

        // hazards
        for (const h of world.hazards || []) {
          ctx.fillStyle = "#501a1a";
          ctx.fillRect(h.x, h.y, h.w, h.h);
          ctx.fillStyle = "#ff8b6b";
          ctx.fillRect(h.x + 6, h.y + h.h - 18, h.w - 12, 12);
        }

        // shards
        for (const s of world.shards) {
          ctx.fillStyle = "#fff29b";
          roundRect(ctx, s.x, s.y, s.w, s.h, 3, true, false, "#fff29b");
          ctx.fillStyle = "rgba(255,255,255,0.08)";
          ctx.fillRect(s.x + 2, s.y + 2, s.w - 4, s.h - 4);
        }

        // enemies (drawn canvas)
        for (const e of enemies) {
          if (!e.alive) continue;
          const bob = Math.sin((e.x + performance.now() * 0.002) * 0.02) * 1.5;
          drawEnemySprite(ctx, e.x, e.y + bob, e.w, e.h);
          // NOTE: removed the previous "stun line" drawn under the enemy (per your request)
        }

        // choose sprite
        let spr = SPR_idle;
        if (player.attacking) spr = SPR_attack;
        if (player.dashCooldown > 0) spr = SPR_dash;

        // frames
        const frameH = spr.naturalHeight || spr.height || 1;
        const frameCount = Math.max(
          1,
          Math.floor(
            (spr.naturalWidth || spr.width || player.w) / Math.max(1, frameH)
          )
        );
        player.anim.t += player.anim.speed;
        if (player.anim.t >= frameCount) player.anim.t = 0;
        const frameIndex = Math.floor(player.anim.t) % frameCount;

        // draw player with flip
        ctx.save();
        ctx.translate(player.x + player.w / 2, player.y + player.h / 2);
        if (player.facing < 0) ctx.scale(-1, 1);
        try {
          const sourceH = frameH;
          const sourceW =
            (spr.naturalWidth || spr.width || player.w) /
            Math.max(1, frameCount);
          ctx.drawImage(
            spr,
            frameIndex * sourceW,
            0,
            sourceW,
            sourceH,
            -player.w / 2,
            -player.h / 2,
            player.w,
            player.h
          );
        } catch (e) {
          ctx.fillStyle =
            player.invuln > 0 ? "rgba(255,200,200,0.9)" : "#bfe8ff";
          ctx.fillRect(
            -player.w / 2 + 8,
            -player.h / 2 + 6,
            player.w - 16,
            player.h - 20
          );
          ctx.fillStyle = "#143a4a";
          ctx.fillRect(
            -player.w / 2 + 12,
            -player.h / 2 + 28,
            player.w - 24,
            player.h - 34
          );
          ctx.fillStyle = "#ffdede";
          ctx.fillRect(-6, -player.h / 2 + 18, 4, 4);
        }
        ctx.restore();

        // particles
        for (const p of particles) {
          ctx.fillStyle = p.col;
          circle(ctx, p.x, p.y, p.size);
        }

        ctx.restore();
      }

      // rounded rect helper
      function roundRect(
        ctx,
        x,
        y,
        w,
        h,
        r,
        fill = true,
        stroke = false,
        fillColor = "#222"
      ) {
        ctx.beginPath();
        ctx.moveTo(x + r, y);
        ctx.arcTo(x + w, y, x + w, y + h, r);
        ctx.arcTo(x + w, y + h, x, y + h, r);
        ctx.arcTo(x, y + h, x, y, r);
        ctx.arcTo(x, y, x + w, y, r);
        ctx.closePath();
        if (fill) {
          ctx.fillStyle = fillColor;
          ctx.fill();
        }
        if (stroke) {
          ctx.stroke();
        }
      }

      // ---------- MAIN LOOP ----------
      function loop(t) {
        const dt = t - last;
        last = t;
        update(dt);
        draw();
        if (running) requestAnimationFrame(loop);
      }

      // initial menu render
      function drawMenu() {
        ctx.clearRect(0, 0, W, H);
        ctx.fillStyle = "#041426";
        ctx.fillRect(0, 0, W, H);
        ctx.fillStyle = "#e6eef8";
        ctx.font = "28px Inter, Arial";
        ctx.textAlign = "left";
        ctx.fillText("hello knoght", 36, 64);
        ctx.font = "14px Inter, Arial";
        ctx.fillStyle = "#cfe7ff";
        ctx.fillText("idfk waht to say bro", 36, 96);
        ctx.fillStyle = "#ff8b8b";
        ctx.fillRect(36, 110, 120, 6);
        // silhouette placeholder
        ctx.save();
        ctx.translate(180, 240);
        ctx.fillStyle = "#bfe8ff";
        ctx.beginPath();
        ctx.moveTo(0, -36);
        ctx.lineTo(18, 0);
        ctx.lineTo(-18, 0);
        ctx.closePath();
        ctx.fill();
        ctx.fillStyle = "#143a4a";
        ctx.fillRect(-12, 0, 24, 40);
        ctx.restore();
      }
      drawMenu();

      // UI bindings
      document.getElementById("startBtn").addEventListener("click", () => {
        showPanel(
          "Prologue",
          `<p style="line-height:1.4">you are hello knoght your i think 66 or 67 rated in the world</p>
    <div style="margin-top:12px;text-align:right"><button id="enterBtn" class="bigbtn">get the fuck in</button></div>`
        );
        document.getElementById("enterBtn").addEventListener("click", () => {
          hidePanel();
          setTimeout(() => {
            reset();
            last = performance.now();
            requestAnimationFrame(loop);
            document.getElementById("startBtn").style.display = "none";
            document.getElementById("restartBtn").style.display =
              "inline-block";
          }, 120);
        });
      });

      document.getElementById("restartBtn").addEventListener("click", () => {
        levelIndex = 0;
        reset();
        last = performance.now();
        requestAnimationFrame(loop);
        document.getElementById("startBtn").style.display = "none";
        document.getElementById("restartBtn").style.display = "inline-block";
      });

      // expose quick start
      window.startGame = () => {
        document.getElementById("startBtn").click();
      };
    </script>
  </body>
</html>
